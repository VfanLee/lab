"use strict";define(["knockout","director"],function(h){function c(e){var t=(e=e||koViewRouterInstance.getRoute())[e.length-1];return""==t&&(e.pop(),t=e[e.length-1]),t&&(t=-1<t.indexOf("?")?t.substring(0,t.indexOf("?")):t,""==(e[e.length-1]=t))&&e.pop(),e}function R(e){e=e||c();for(var t=koViewRouterInstance.routes,n=0;n<e.length;n++){var o=e[n];if(null==t[o])return!!t["?((w|.)*)"];t=t[o]}return!(!t["?((w|.)*)"]&&!t.on)}return function(e){var o=this;if(o.routingRules=e.routingRules,o.routingRules){o.showViewPage=h.observable(!1),o.viewParams=h.observable(),o.id="koView"+(1e3*Math.random()).toFixed(0),window.koViewRouterInstance=window.koViewRouterInstance||null,window.koViewRouterPreviousRoute=window.koViewRouterPreviousRoute||[],window.routeChangedByUser=null==window.routeChangedByUser||window.routeChangedByUser;var r,i,u=!1,s="",a=[];if(koViewRouterInstance&&(!koViewRouterInstance||koViewRouterInstance instanceof Router)){f=koViewRouterInstance;for(t in o.routingRules)o.routingRules.hasOwnProperty(t)&&(n=g(o.routingRules[t].rule,o.routingRules[t].title,e=o.routingRules[t].params),l=o.routingRules[t].after,f.on(t,n),f.on("after",t,l),t+="/?((w|.)*)",f.on(t,n),f.on("after",t,l));(function e(t){var n=!1;for(var o in t)if(t.hasOwnProperty(o)){if("?((w|.)*)"!=o&&"on"!=o&&"after"!=o)delete t["?((w|.)*)"],n=!0;else if(t[o]instanceof Array&&1<t[o].length)for(var r=0;r<t[o].length-1;r++)t[o].shift();"function"!=typeof t[o]&&e(t[o])}return n})(f.routes)&&routeChangedByUser&&R()&&koViewRouterInstance.dispatch("on",location.hash.substring(1))}else{var t,n,l,w={};for(t in o.routingRules)o.routingRules.hasOwnProperty(t)&&(n=g(o.routingRules[t].rule,o.routingRules[t].title,e=o.routingRules[t].params),l=o.routingRules[t].after,w[t]={on:n,after:l},w[t+="/?((w|.)*)"]={on:n,after:l});var f=new Router(w);(koViewRouterInstance=f).configure({notfound:function(){f.setRoute("/index")},after:function(){if($(".modal").remove(),$(".modal-backdrop").remove(),""!=s&&-1==location.hash.indexOf(s)&&(routeChangedByUser=!0,clearTimeout(u)),routeChangedByUser&&function(){var e=c();if(1<e.length){if(koViewRouterPreviousRoute.length<e.length-1)return 1;for(var t=0;t<e.length-1;t++)if(koViewRouterPreviousRoute[t]!=e[t])return 1}return}()){var e=location.hash.split("/");if(2<e.length){e.shift();for(var t=[],n="";0<e.length;)R(c((n+="/"+e.shift()).substring(1).split("/")))&&t.push(n);routeChangedByUser=!1,clearTimeout(u),!function e(t){{var n;0<t.length?(n=t.shift(),s=n,koViewRouterInstance.dispatch("on",n),u=setTimeout(function(){e(t)},500)):routeChangedByUser=!(u=!1)}}(t)}}}}),f.init()}}function g(e,t,n){return function(){koViewRouterPreviousRoute=c(),t&&(document.title=t),!o.showViewPage()||0==$("#"+o.id).length||$("#"+o.id).html()?(h.components.unregister("ko-view"),h.components.register("ko-view",e),i=e,o.viewParams(n),o.showViewPage(!1),o.showViewPage(!0)):e!=i&&((a=[]).push(function(){h.components.unregister("ko-view"),h.components.register("ko-view",e),o.viewParams(n),o.showViewPage(!1),o.showViewPage(!0)}),r=r||setInterval(function(){var e;0==$("#"+o.id).length&&(clearInterval(r),r=null),$("#"+o.id).html()&&(e=a.shift(),0==a.length&&(clearInterval(r),r=null),e())},1e3))}}}});